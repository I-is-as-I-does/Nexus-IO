/*! Nexus | (c) 2021-22 I-is-as-I-does | AGPLv3 license */
"use strict";(self.webpackChunknexus_io=self.webpackChunknexus_io||[]).push([[20],{49:(t,e,i)=>{i.d(e,{N:()=>O});var s=i(478),a=i(457),n=i(171),d=i(983),r=i(397),h=i(115);function l(){var t=(0,a.gd)("BUTTON","nx-add-link");return t.type="button",t.textContent="+",t}function c(t,e,i){var s=!1;h.SO[i][1]<=e.length&&(s=!0),t.disabled!==s&&(t.classList.toggle("nx-disabled"),t.disabled=s)}const o={image:["jpg","jpeg","gif","svg","png","webp"],video:["mp4","webm"],audio:["mp3"]},u=new CustomEvent("StateChange"),p=new CustomEvent("ThreadChange"),v=new CustomEvent("IndexChange");function g(t,e=!1){var i=t.classList.contains("nx-disabled");!e&&i?t.classList.remove("nx-disabled"):e&&!i&&t.classList.add("nx-disabled")}function x(t,e,i){if(-1!==t.indexOf(e))for(var s=0;s<t.length;s++)if(s!==i&&t[s]===e)return!1;return!0}function I(t,e,i){var s;if(s=e,!x(t,e=(0,n.V7)(s).trim().replace(/[^A-Za-z0-9]+/g,"-").replace(/(^-|-$)+/g,""),i)){var a,d=e.split("-"),r=d.pop();for(isNaN(r)?(d.push(r),a=1):(a=parseInt(r),a++),e=d.join("-");t.includes(e+"-"+a);)a++;e+="-"+a}return e}var f=i(52),E=i(498),k=i(676),m=i(754),_=i(472);function T(t,e="nexus-tmp",i="/",s=-1){return{dataUrl:e,srcData:t,threadId:i,threadIndex:s}}function S(){var t=(0,n.O1)(10);return{nexus:h.Gd,author:{handle:"Anonymous-"+(0,n.Iy)(100,999),about:"",url:"http://"},threads:[L(t)],index:[t]}}function L(t){return{id:t,title:t,description:"...",content:{timestamp:(new Date).toISOString().substring(0,16),main:"...",aside:"",media:{url:"",type:"",caption:""}},linked:[]}}class b{constructor(t){this.EditState=t,this._setMenu()}getMenuElms(){return this.menu}setLastAction(t,e=!1){this.resetting&&!e||(this.lastAction.act=t,this.actCtrls.count=2,this.actCtrls.position=1,(0,a.eV)(this.actCtrls),this.toggleSaveBtn(!1))}setResetting(t){this.resetting=t}toggleSaveBtn(t=!1){g(this.saveBtn,t)}_displayFeedback(t){var e=(0,_.GY)(t);this.feedbackrun&&clearTimeout(this.feedbackrun),(0,d.Po)(this.actionFdbck,e,25),this.feedbackrun=setTimeout(function(){(0,d.Po)(this.actionFdbck,"",25)}.bind(this),1500+20*e.length)}_resetData(t){var e=this.EditState.getJsonState();null===t&&(t=S());var i=T(t);i.srcData.threads.length&&(i.threadIndex=0,i.threadId=i.srcData.threads[0].id);var s=JSON.stringify(i),a=function(t){var i;i=t?s:e,this.EditState.setNewState(i),this.menu.dispatchEvent(u)}.bind(this);a(!0),this.setLastAction(a,!0)}_setActionFeedback(){this.feedbackrun=null,this.actionFdbck=(0,a.gd)("SPAN","nx-action-feedback")}_setDownloadBtn(){this.dlBtn=(0,a.gd)("A","nx-download"),this.dlBtn.append((0,a.cy)(r.aL,20)),this.dlBtn.addEventListener("click",function(){var t=Object.assign({},this.EditState.state.srcData);delete t.index,(0,m.wJ)(t)||this._displayFeedback("Invalid Nexus data"),t=JSON.stringify(t,void 0,2);var e="data:text/json;charset=utf-8,"+encodeURIComponent(t),i=(0,a.gd)("A");i.setAttribute("href",e),i.setAttribute("download","nexus.json"),document.body.appendChild(i),i.click(),i.remove()}.bind(this))}_setNewDocumenBtn(){this.newBtn=(0,a.gd)("A","nx-new"),this.newBtn.append((0,a.cy)(r.j4,20)),this.newBtn.addEventListener("click",function(){this._resetData(S())}.bind(this))}_setOpenBtn(){this._setFileInput(),this.openBtn=(0,a.gd)("A","nx-open-file"),this.openBtn.append((0,a.cy)(r.r5,20)),this.openBtn.addEventListener("click",function(){this.fileInput.click()}.bind(this)),this.openWrap=(0,a.gd)("SPAN"),this.openWrap.append(this.fileInput,this.openBtn)}_setFileInput(){this.fileInput=(0,a.gd)("INPUT"),this.fileInput.type="file",this.fileInput.accept="application/json",this.fileInput.addEventListener("change",function(t){(0,f.eD)(t,!0).then((t=>{t.index=(0,f.HE)(t),this._resetData(t)})).catch((t=>{(0,E.fZ)(t.message),this._displayFeedback("Invalid source")})),this.fileInput.value=""}.bind(this)),this.fileInput.style.display="none"}_setSaveBtn(){this.saveBtn=(0,a.gd)("A","nx-save"),this.saveBtn.append((0,a.cy)(r.Ne,20)),g(this.saveBtn,!0),this.saveBtn.addEventListener("click",function(){if(!this.saveBtn.classList.contains("nx-disabled")){var t=this.EditState.state;(0,k.EW)(t.dataUrl,t.srcData),this._displayFeedback("saved"),g(this.saveBtn,!0),this._setResetStatus()}}.bind(this))}_setResetStatus(){var t=!0;this.EditState.originData!==JSON.stringify(this.EditState.state.srcData)&&(t=!1),g(this.resetBtn,t)}_setResetBtn(){this.resetBtn=(0,a.gd)("A","nx-reset"),this.resetBtn.append((0,a.cy)(r.os,20)),this._setResetStatus(),this.resetBtn.addEventListener("click",function(){this.resetBtn.classList.contains("nx-disabled")||(this._resetData(JSON.parse(this.EditState.originData)),g(this.resetBtn,!0))}.bind(this))}_setEditNav(){this._setActionFeedback(),this._setResetBtn(),this._setNewDocumenBtn(),this._setOpenBtn(),this._setSaveBtn(),this._setDownloadBtn(),this.editLinks=(0,a.gd)("DIV"),this.editLinks.append(this.resetBtn,this.newBtn,this.openWrap,this.saveBtn,this.dlBtn),this.editNav=(0,a.gd)("DIV","nx-edit-nav"),this.editNav.append(this.actionFdbck,this.editLinks)}_setEditActions(){this.resetting=!1,this.lastAction={act:null},this.actCtrls={ctrls:{prev:{symbol:r.nA,elm:null},next:{symbol:r.rQ,elm:null}},position:0,count:1},this.editActions=(0,a.gd)("DIV","nx-edit-actions nx-history-nav"),(0,a.Q$)(this.actCtrls,this._triggerUndoRedo.bind(this),!0),this.editActions.append(this.actCtrls.ctrls.prev.elm,this.actCtrls.ctrls.next.elm)}_triggerUndoRedo(t){this.lastAction.act("next"===t),this.toggleSaveBtn(!1)}_setMenu(){this._setEditNav(),this._setEditActions(),this.menu=(0,a.gd)("DIV","nx-edit-menu"),this.menu.append(this.editNav,this.editActions)}}var D=i(750);class B{constructor(t,e){this.EditState=t,this.EditMenu=e}inputElm(t,e=null,i=null){var s=this._fieldIdents(t),n=this._resolveInput(s,t),d=this._baseLabel(s.alias),r=(0,a.gd)("SPAN","nx-edit-indication"),h=this._invalidSp();d.append(r,h),this._setConditions(s,n,r),i&&(i[s.field]=n);var l=this._wrapInput(s,n,d);return this._setInputEvt(t,n,h,e),this._inputEvtHandler(t,n,h,e),l}_setConditions(t,e,i){switch(t.field){case"url":case"linked":i.textContent="[http]",e.pattern=h.Ni;break;case"id":i.textContent="[A-Za-z0-9-][3-36]",e.pattern=h.Q1;break;case"type":e.pattern="("+h.WS.join("|")+")";break;case"timestamp":break;default:var s=h.m2[t.field];i.textContent="["+s[0]+"-"+s[1]+"]",e.setAttribute("maxlength",s[1]),e.setAttribute("minlength",s[0])}}_wrapInput(t,e,i){var s=(0,a.gd)("DIV","nx-edit-input nx-edit-"+t.parent+"-"+t.field);return s.append(i),"type"===t.field?s.append(this._typeDropDown(e)):s.append(e),s}_typeDropDown(t){var e=h.WS;return(0,a.Sb)(e,t,null,"nx-edit-media-type-select")}_fieldIdents(t){var e={},i=t.length-1;return"linked"===t[i-1]&&i--,e.field=t[i],"threads"===t[--i-1]&&i--,e.parent=t[i],e.alias=e.field,"linked"===e.field&&(e.alias="url"),e}_isLongTextInput(t){return["about","description","main","aside","caption"].includes(t.field)}_isRequired(t){return["handle","title","main","id","url","type","timestamp","linked"].includes(t.field)}_resolveInput(t,e){var i,s=this.EditState.getValue(e);(i=this._isLongTextInput(t)?this._textareaInput(s):"timestamp"==t.field?this._dateInput(s):this._textInput(s)).classList.add("nx-edit-input");var a=e.join("-");return i.id=a,i.name=a,this._isRequired(t)&&(i.required=!0),i}_textInput(t){var e=(0,a.gd)("INPUT","nx-edit-text");return e.type="text",e.value=t,e}_textareaInput(t){var e=(0,a.gd)("TEXTAREA","nx-edit-textarea");return e.textContent=t,e}_dateInput(t){var e=(0,a.gd)("INPUT","nx-edit-date");return e.type="datetime-local",e.value=t,e}_baseLabel(t){var e=(0,a.gd)("LABEL","nx-edit-label");e.for=t;var i=(0,a.gd)("SPAN","nx-edit-title");return i.textContent=(0,_.GY)(t),(0,D.wu)(i,t),e.append(i),e}_invalidSp(){var t=(0,a.gd)("SPAN","nx-edit-feedback");return t.append((0,a.cy)(r.mb)),t}_inputEvtHandler(t,e,i,s){var a=e.checkValidity(),n=null;if(a&&t.includes("url")||t.includes("linked"))(a=(0,m.jv)(e.value))&&t.includes("linked")&&(a=x(this.EditState.getLinkedUrls(t[1]),e.value,this.EditState.getLinkedThreadIdx(t[1],t[3])))&&(n=(0,f.P_)(e.value).then((()=>!0)).catch((()=>!1)));else if(t.includes("id")){var d=I(this.EditState.getIdsList(),e.value,this.EditState.getThreadIdx(t[1]));d!==e.value&&(e.value=d),a=!0}null===n&&(n=Promise.resolve(a)),n.then((a=>{this.EditState.setNewValue(t,e.value),this._setFeedbackIcon(i,a),"function"==typeof s&&s(e,a)}))}_setFeedbackIcon(t,e){var i=r.mb;e&&(i=r.b8),t.firstChild.src=i}_setInputEvt(t,e,i,s){var a=0,n="",d=e.value;e.addEventListener("focus",(function(){d=e.value})),e.addEventListener("change",function(){if(this._inputEvtHandler(t,e,i,s),a>0){var r=function(a){a?e.value=n:(n=e.value,e.value=d),this._inputEvtHandler(t,e,i,s)}.bind(this);this.EditMenu.setLastAction(r)}else a++}.bind(this))}}class y{constructor(t){this.InputsFactory=t}newThreadLocalForm(t,e){var i=(0,a.gd)("FORM","nx-thread-local-form"),s=this._localFieldSet1(t,e),n=this._localFieldSet2(t),d=this._localFieldSet3(t);return i.append((0,a.a)("local thread"),s,(0,a.a)("content"),n,(0,a.a)("media"),d),i}_localFieldSet1(t,e){var i=(0,a.gd)("FIELDSET");return i.append(this.InputsFactory.inputElm(["threads",t,"id"])),i.append(this.InputsFactory.inputElm(["threads",t,"title"],(function(t){var i=e.querySelector(".nx-thread-title");i.textContent!==t.value&&(i.textContent=t.value)}))),i.append(this.InputsFactory.inputElm(["threads",t,"description"])),i}_localFieldSet2(t){var e=(0,a.gd)("FIELDSET");return["timestamp","main","aside"].forEach((i=>{e.append(this.InputsFactory.inputElm(["threads",t,"content",i]))})),e}_localFieldSet3(t){var e=(0,a.gd)("FIELDSET"),i=this.InputsFactory.inputElm(["threads",t,"content","media","type"]);return e.append(this.InputsFactory.inputElm(["threads",t,"content","media","url"],(function(t,e){if(e){var s=i.querySelector("[data-item="+function(t){for(var e=0;e<h.S3.length;e++)if(t.includes(h.S3[e]))return h.S3[e];var i=t.split(".").pop();for(let[t,e]of Object.entries(o))if(e.includes(i))return t;return"page"}(t.value)+"]");s&&s.click()}}))),e.append(i),e.append(this.InputsFactory.inputElm(["threads",t,"content","media","caption"])),e}}class C{constructor(t){this.EditState=t,this._setContainers(),this._setBtnSrc(),this._setMenu(),this._setFactories(),this._setAddThreadBtn(),this._setFormsInputs(),this._setFormBlocks(),this._setServiceElms()}getInstanceElms(){return this.instanceElms}_setBtnSrc(){this.btnSrc={up:r.MK,down:r.jF}}_setContainers(){this.containers={author:(0,a.gd)("FORM","nx-edit-author"),index:(0,a.gd)("UL","nx-edit-index"),local:(0,a.gd)("UL","nx-edit-local"),distant:(0,a.gd)("UL","nx-edit-distant")}}_setMenu(){this.EditMenu=new b(this.EditState),this.menu=this.EditMenu.getMenuElms(),this.menu.addEventListener("StateChange",this._resetFormCallback.bind(this))}_setFactories(){this.InputsFactory=new B(this.EditState,this.EditMenu),this.LocalFormFactory=new y(this.InputsFactory)}_setAddThreadBtn(){this.addThreadBtn=l(),c(this.addThreadBtn,this.EditState.getIdsList(),"threads"),this.addThreadBtn.addEventListener("click",this._addThreadHandler.bind(this))}_setServiceElms(){var t=(0,a.gd)("DIV","nx-main-block nx-index");t.append(this.formBlocks.author,this.formBlocks.index);var e=(0,a.gd)("DIV","nx-main-block nx-thread");e.append(this.formBlocks.local,this.formBlocks.distant),this.instanceElms=(0,a.IW)((0,a.vi)(),[(0,a._$)([this.menu],[t,e],[],"edit")])}_setFormBlocks(){this.formBlocks={author:(0,a.rH)("author",[this.containers.author],(0,a.a)("author")),index:(0,a.rH)("threads-list",[this.containers.index,this.addThreadBtn],(0,a.a)("threads")),local:(0,a.rH)("local",[this.containers.local],!1),distant:(0,a.rH)("distant",[this.containers.distant],!1)}}_resetFormCallback(){Object.values(this.containers).forEach(((t,e)=>{var i=Array.from(t.childNodes),s=3===e,a=i.length-1;i.forEach(((t,e)=>{(0,d.U6)(t,function(){t.remove(),s&&e===a&&this._setFormsInputs()}.bind(this))}))}))}_setFormsInputs(){this._setAuthorInputs(),this._setThreadsInputs()}_setAuthorInputs(){["handle","url","about"].forEach((t=>{var e=this.InputsFactory.inputElm(["author",t]);e.style.display="none",this.containers.author.append(e),(0,d.Ji)(e)}))}_setThreadsInputs(){var t=this.EditState.getIdsList();if(t.length){this.EditMenu.setResetting(!0);for(var e=!1,i=0;i<t.length;i++)i===t.length-1&&(e=!0),this._setThread(t[i],i,e)}}_setThread(t,e,i=!1){var s=this.EditState.newIdent(t,e),a=this._newThreadLis(s),n=0;for(let[t,s]of Object.entries(a)){n++;var r=null;"none"!==s.style.display&&(s.style.display="none",r=function(){"local"===t?(0,d.Ji)(s):(0,d.YQ)(s,200)}),this.containers[t].append(s),r&&r(),i&&3===n&&(this.EditMenu.setResetting(!1),e-1!=-1&&this.containers.index.childNodes[e-1].dispatchEvent(v))}}_newThreadLis(t){var e={};return e.distant=this._threadLi(t),e.local=this._threadLi(t),e.index=this._indexLi(t),e.distant.append(this._threadDistantForm(t)),e.local.append(this.LocalFormFactory.newThreadLocalForm(t,e.index)),this._setdeleteThreadElm(e,t),e}_addThreadHandler(){if(!this.addThreadBtn.disabled){var t=(0,n.O1)(10),e=this.EditState.getThreadsCount();this.EditState.pushThread(L(t)),this.EditMenu.setResetting(!0),this._setThread(t,e,!0),this.EditMenu.toggleSaveBtn(!1),c(this.addThreadBtn,this.EditState.getIdsList(),"threads")}}_linkInput(t,e,i,s){var n=this.EditState.registerLinkedThread(i,s),r=(0,a.gd)("DIV","nx-edit-distant-link"),h={linked:null},l=this.InputsFactory.inputElm(["threads",i,"linked",n],null,h),o=this._baseDeleteLinkBtn(),u=(0,a.gd)("DIV","nx-distant-link-action");return u.append(o),o.addEventListener("click",(()=>{var s=function(s){var a=this.EditState.getLinkedUrls(i);if(s)(0,d.Vv)(r,200,(function(){r.remove()})),this.EditState.removeLinkedThread(i,n);else{var l=this.EditState.getLinkedThreadIdx(i,n),o=l===a.length;if(this.EditState.insertLinkedThread(i,n,h.linked.value),o)(0,d.am)(e,r,!1,!0,200);else{var u=e.childNodes[l];e.insertBefore(r,u),(0,d.YQ)(r,200)}}c(t,a,"linked")}.bind(this);this.EditMenu.setLastAction(s),s(!0)})),r.append(l,u),r}_threadDistantForm(t){var e=(0,a.gd)("FORM","nx-thread-distant-form"),i=l();c(i,this.EditState.getLinkedUrls(t),"linked"),i.addEventListener("click",(()=>{i.disabled||(this.EditState.pushLinkedThread(t,""),(0,d.am)(e,this._linkInput(i,e,t,this.EditState.getLinkedUrlsCount(t)-1),!1,!0,200),c(i,this.EditState.getLinkedUrls(t),"linked"))}));var s=this.EditState.getLinkedUrlsCount(t);if(s){for(var n=[],r=0;r<s;r++){var h=this._linkInput(i,e,t,r);n.push(h)}e.append(...n)}var o=(0,a.gd)("DIV");return o.append((0,a.a)("linked threads"),e,i),o}_threadLi(t){var e=(0,a.gd)("LI");return this.EditState.isCurrentId(t)||(e.style.display="none"),e.addEventListener("ThreadChange",function(){this.EditState.isCurrentId(t)?setTimeout((function(){(0,d.YQ)(e,200)}),200):(0,d.Vv)(e,200)}.bind(this)),e}_setdeleteThreadElm(t,e){var i=(0,a.gd)("BUTTON","nx-delete-thread");i.type="button",i.textContent="-",i.addEventListener("click",function(){this._deleteEvent(t,e)}.bind(this)),t.index.append(i)}_deleteEvent(t,e){var i=Object.assign({},this.EditState.getThreadData(e)),s=function(s){var a=this.EditState.getThreadIdx(e),n=this.EditState.getThreadsCount();if(s)this.EditState.removeThread(e),Object.values(t).forEach((t=>{(0,d.Vv)(t,200,(function(){t.remove()}))})),n>1&&(0===a?t.index.nextSibling.dispatchEvent(v):a===n-1&&t.index.previousSibling.dispatchEvent(v)),this.EditState.isCurrentId(e)&&(t.distant.dispatchEvent(p),t.local.dispatchEvent(p));else{if(this.EditState.insertThread(e,i),a<=n-1){var r=this.containers.index.childNodes[a];this.containers.index.insertBefore(t.index,r),0===a&&r.dispatchEvent(v)}else this.containers.index.append(t.index),n>1&&t.index.previousSibling.dispatchEvent(v);this.containers.local.append(t.local),this.containers.distant.append(t.distant),(0,d.YQ)(t.index,200),t.index.firstChild.click()}c(this.addThreadBtn,this.EditState.getIdsList(),"threads")}.bind(this);this.EditMenu.setLastAction(s),s(!0)}_indexLi(t){var e=(0,a.gd)("LI");return e.dataset.ident=t,e.append(this._indexLink(t)),this._setMoveBtns(e,t),e}_indexLink(t){var e=this.EditState.getAltEditState(t),i=(0,a.j1)(e,!1);return this.EditState.isCurrentId(t)&&i.classList.add("nx-on-display"),i.addEventListener("click",(()=>{if(!this.EditState.isCurrentId(t)){this.EditState.changeCurrentThread(t);var e=this.containers.index.querySelector(".nx-on-display");e&&e.classList.remove("nx-on-display"),i.classList.add("nx-on-display"),this.containers.local.childNodes.forEach((t=>{t.dispatchEvent(p)})),this.containers.distant.childNodes.forEach((t=>{t.dispatchEvent(p)}))}})),i}_toggleActiveBtn(t,e){this.EditState.isFirstThread(t)?g(e.up,!0):g(e.up,!1),this.EditState.isLastThread(t)?g(e.down,!0):g(e.down,!1)}_permuteThread(t,e){this.containers.index.removeChild(t),this.containers.index.insertBefore(t,e),e.dispatchEvent(v),t.dispatchEvent(v)}_moveItemHandler(t,e,i){var s=function(s){var a,n="up"==e;s||(n=!n),n&&!this.EditState.isFirstThread(i)?(a=t.previousSibling,this.EditState.moveThread(i,a.dataset.ident,!0),this._permuteThread(t,a)):n||this.EditState.isLastThread(i)||(a=t.nextSibling,this.EditState.moveThread(i,a.dataset.ident,!1),this._permuteThread(a,t))}.bind(this);this.EditMenu.setLastAction(s),s(!0)}_setMoveBtns(t,e){var i=(0,a.gd)("DIV","nx-edit-move"),s={up:null,down:null};t.addEventListener("IndexChange",function(){this._toggleActiveBtn(e,s)}.bind(this)),Object.keys(s).forEach((n=>{s[n]=(0,a.gd)("A","nx-edit-move-"+n),s[n].append((0,a.cy)(this.btnSrc[n],16)),i.append(s[n]),s[n].addEventListener("click",function(){this._moveItemHandler(t,n,e)}.bind(this))})),this._toggleActiveBtn(e,s),t.append(i)}_baseDeleteLinkBtn(){var t=(0,a.gd)("BUTTON","nx-delete-link");return t.type="button",t.textContent="-",t}}class w{constructor(t,e,i){this.editInst=t,this.readerInst=e,this.readerUpdatePrc=i,this.previewOn=!1,this._setSwitchBtn()}getSwitchBtn(){return this.switchBtn}_instanceSwitch(){this.previewOn=!this.previewOn,this.previewOn?(0,d.U6)(this.editInst,function(){this.readerUpdatePrc(),this.switchBtn.firstChild.src=r.bR,(0,d.Ji)(this.readerInst)}.bind(this)):(0,d.U6)(this.readerInst,function(){this.switchBtn.firstChild.src=r.xQ,(0,d.Ji)(this.editInst)}.bind(this))}_setSwitchBtn(){this.switchBtn=(0,a.gd)("A","nx-edit-switch"),this.switchBtn.append((0,a.cy)(r.xQ,25)),this.switchBtn.addEventListener("click",this._instanceSwitch.bind(this))}}var F=i(545),A=i(937);class M{constructor(t){var e="nexus-tmp",i=null;(0,A.pm)("new")?(i=S(),t=null):(t.dataUrl&&(e=t.dataUrl),null===(i=(0,k.Ih)(e))&&(i=null!==t.srcData?t.srcData:S(),(0,k.EW)(e,i))),i.index||(i.index=(0,f.HE)(i));var s=i;null!==t&&null!==t.srcData&&(s=t.srcData),this.originData=JSON.stringify(s);var a=i.threads[0].id,n=0;t&&"/"!==t.threadId&&i.index.includes(t.threadId)&&(a=t.threadId,n=i.index.indexOf(t.threadId)),this.state=T(i,e,a,n),this.threadsMap={}}getState(){return this.state}getOriginData(){return this.originData}getJsonState(){return JSON.stringify(this.state)}getAltEditState(t){return(0,F.DX)(this.state,this.getThreadId(t),this.getThreadIdx(t))}setNewState(t){this.state=Object.assign({},JSON.parse(t))}setAuthorValue(t,e){this.state.srcData.author||(this.state.srcData.author={}),this.state.srcData.author[t[1]]=e}setThreadIndex(t){if(this.state.srcData.threads){var e=this.getThreadIdx(t);void 0===this.state.srcData.threads[e]&&(this.state.srcData.threads[e]={})}else this.state.srcData.threads=[]}setThreadId(t,e){this.threadsMap[t[1]].id=e;var i=this.getThreadIdx(t[1]);this.state.srcData.index[i]=e,this.state.srcData.threads[i].id=e}setThreadInfo(t,e){var i=this.getThreadIdx(t[1]);this.state.srcData.threads[i][t[2]]=e}setContentValue(t,e){var i=this.getThreadIdx(t[1]);this.state.srcData.threads[i].content||(this.state.srcData.threads[i].content={}),"media"===t[3]?(this.state.srcData.threads[i].content.media||(this.state.srcData.threads[i].content.media={}),this.state.srcData.threads[i].content.media[t[4]]=e):this.state.srcData.threads[i].content[t[3]]=e}setLinkedValue(t,e){var i=this.getThreadIdx(t[1]);if(this.state.srcData.threads[i].linked){var s=this.getLinkedThreadIdx(t[1],t[3]);this.state.srcData.threads[i].linked[s]=e}else this.state.srcData.threads[i].linked=[e]}setNewValue(t,e){return null===this.state.srcData&&(this.state.srcData={},this.state.srcData.index=[]),"author"===t[0]?this.setAuthorValue(t,e):(this.setThreadIndex(t[1]),"id"===t[2]?this.setThreadId(t,e):["linked","content"].includes(t[2])?"content"===t[2]?this.setContentValue(t,e):void this.setLinkedValue(t,e):this.setThreadInfo(t,e))}getValue(t){if(this.state.srcData){if("author"===t[0])return this.state.srcData.author[t[1]];var e=this.getThreadIdx(t[1]);if(!["linked","content"].includes(t[2]))return this.state.srcData.threads[e][t[2]];if("content"===t[2])return"media"!==t[3]?this.state.srcData.threads[e].content[t[3]]:this.state.srcData.threads[e].content.media[t[4]];var i=this.getLinkedThreadIdx(t[1],t[3]);return this.state.srcData.threads[e].linked[i]}return""}getThreadId(t){return this.threadsMap[t].id}getThreadIdx(t){var e=this.threadsMap[t].idx,i=this.getThreadsCount();return e>=i&&(e=i-1,this.threadsMap[t].idx=e,this.isCurrentId(t)&&(this.state.threadIndex=e)),e}getIdsList(){return this.state.srcData.index}getThreadsCount(){return this.state.srcData.index.length}getCurrentThreadId(){return this.state.threadId}getCurrentThreadIdx(){return this.state.threadIndex}isCurrentId(t){return this.threadsMap[t].id===this.state.threadId}unsetCurrentThread(){this.state.threadId="/",this.state.threadIndex=-1}isFirstThread(t){return 0===this.getThreadIdx(t)}isLastThread(t){return this.getThreadIdx(t)+1===this.getThreadsCount()}getThreadData(t){var e=this.getThreadIdx(t),i=this.state.srcData.threads[e];return i||(this.state.srcData.threads[e]={}),i}removeThread(t){var e=this.getThreadIdx(t);if(this.state.srcData.index.splice(e,1),this.state.srcData.threads.splice(e,1),!this.isLastThread(t))for(let[t,i]of Object.entries(this.threadsMap))i.idx>e&&(this.threadsMap[t].idx=i.idx-1);this.isCurrentId(t)?this.unsetCurrentThread():this.state.threadIndex>e&&this.state.threadIndex--}insertThread(t,e){if(this.isLastThread(t))this.pushThread(e);else{var i=this.getThreadIdx(t);this.state.srcData.index.splice(i,0,e.id),this.state.srcData.threads.splice(i,0,e);for(let[t,s]of Object.entries(this.threadsMap))s.id!==e.id&&s.idx>=i&&(this.threadsMap[t].idx=s.idx+1);this.state.threadIndex>=i&&this.state.threadIndex++}}newIdent(t,e){var i=(0,n.O1)(21);return this.threadsMap[i]={id:t,idx:e,linked:{}},i}changeCurrentThread(t){this.state.threadId=this.getThreadId(t),this.state.threadIndex=this.getThreadIdx(t)}moveThread(t,e,i=!1){var s=this.getThreadIdx(t),a=s+1;i&&(a=s-1),this.state.srcData.index.splice(a,0,this.state.srcData.index.splice(s,1)[0]),this.state.srcData.threads.splice(a,0,this.state.srcData.threads.splice(s,1)[0]),this.threadsMap[t].idx=a,this.threadsMap[e].idx=s,this.isCurrentId(t)?this.state.threadIndex=a:this.isCurrentId(e)&&(this.state.threadIndex=s)}pushThread(t){this.state.srcData.threads.push(t),this.state.srcData.index.push(t.id)}getLinkedThreadIdx(t,e){var i=this.threadsMap[t].linked[e].idx,s=this.getLinkedUrlsCount(t);return i>=s&&(i=s-1,this.threadsMap[t].linked[e].idx=i),i}getLinkedUrls(t){var e=this.getThreadData(t);if(!Object.prototype.hasOwnProperty.call(e,"linked")){var i=this.getThreadIdx(t);return this.state.srcData.threads[i].linked=[],[]}return e.linked}getLinkedUrlsCount(t){return this.getLinkedUrls(t).length}registerLinkedThread(t,e){var i=(0,n.O1)(21);return this.threadsMap[t].linked[i]={idx:e},i}isLastLinkedThread(t,e){return this.getLinkedThreadIdx(t,e)===this.getLinkedUrlsCount(t)-1}removeLinkedThread(t,e){var i=this.getThreadIdx(t),s=this.getLinkedThreadIdx(t,e);if(s===this.getLinkedUrlsCount(t)-1)this.state.srcData.threads[i].linked.pop();else{this.state.srcData.threads[i].linked.splice(s,1);for(let[e,i]of Object.entries(this.threadsMap[t].linked))i.idx>s&&(this.threadsMap[t].linked[e].idx=i.idx-1)}}pushLinkedThread(t,e){var i=this.getThreadIdx(t);this.state.srcData.threads[i].linked.push(e)}insertLinkedThread(t,e,i){if(this.isLastLinkedThread(t,e))this.pushLinkedThread(t,i);else{var s=this.getThreadIdx(t),a=this.getLinkedThreadIdx(t,e);this.state.srcData.threads[s].linked.splice(a,0,i);for(let[i,s]of Object.entries(this.threadsMap[t].linked))s.idx>=a&&i!==e&&(this.threadsMap[t].linked[i].idx=s.idx+1)}}}function O(t){var e=new M(t.state),i=new C(e).getInstanceElms(),n={editMode:!0,state:Object.assign({},e.getState())},d=(0,s.U)(n);d.style.display="none";var r=new w(i,d,(function(){return(0,F.f2)(e.state,!0,!0)})).getSwitchBtn(),h=(0,a.gd)("DIV","nx-editor");return h.append(i,d,r),h}}}]);