/*! Nexus | (c) 2021-22 I-is-as-I-does | AGPLv3 license */
"use strict";(self.webpackChunknexus_io=self.webpackChunknexus_io||[]).push([[20],{837:(e,n,t)=>{t.d(n,{N:()=>me});var a=t(478),d=t(457),i=t(115),r=t(304),c=t(171),s=t(545),l=t(676),o=t(754);function u(){var e=(0,c.O1)(10);return{nexus:i.Gd,author:{handle:"Anonymous-"+(0,c.Iy)(100,999),about:"",url:"http://"},threads:[p(e)],index:[e]}}function p(e){return{id:e,title:e,description:"...",content:{timestamp:(new Date).toISOString().substring(0,16),main:"...",aside:"",media:{url:"",type:"",caption:""}},linked:[]}}var h=t(52),v=t(472),x=t(929),f=t(397);function g(){var e=(0,d.gd)("BUTTON","nx-add-link");return e.type="button",e.textContent="+",e}function D(e,n,t){var a=!1;i.SO[t][1]<=n.length&&(a=!0),e.disabled!==a&&(e.classList.toggle("nx-disabled"),e.disabled=a)}const k={image:["jpg","jpeg","gif","svg","png","webp"],video:["mp4","webm"],audio:["mp3"]};function m(e,n="nexus-tmp",t="/",a=-1){return{dataUrl:n,srcData:e,threadId:t,threadIndex:a}}function b(e,n=!1){var t=e.classList.contains("nx-disabled");!n&&t?e.classList.remove("nx-disabled"):n&&!t&&e.classList.add("nx-disabled")}function E(e,n,t){if(-1!==e.indexOf(n))for(var a=0;a<e.length;a++)if(a!==t&&e[a]===n)return!1;return!0}function I(e,n){var t;t=e,e=(0,c.V7)(t).trim().replace(/[^A-Za-z0-9]+/g,"-").replace(/(^-|-$)+/g,"");var a=ke();if(!E(a.srcData.index,e,n)){var d,i=e.split("-"),r=i.pop();for(isNaN(r)?(i.push(r),d=1):(d=parseInt(r),d++),e=i.join("-");a.srcData.index.includes(e+"-"+d);)d++;e+="-"+d}return e}var y,L,O,S,N,A,C,j=t(937),w=t(498),T={ctrls:{prev:{symbol:f.nA,elm:null},next:{symbol:f.rQ,elm:null}},position:0,count:1},V=!1;function U(){var e=(0,d.gd)("A","nx-download");return e.append((0,d.cy)(f.aL,20)),e.addEventListener("click",(function(){var e=Object.assign({},ke().srcData);delete e.index,(0,o.wJ)(e)||H("Invalid Nexus data"),e=JSON.stringify(e,void 0,2);var n="data:text/json;charset=utf-8,"+encodeURIComponent(e),t=(0,d.gd)("A");t.setAttribute("href",n),t.setAttribute("download","nexus.json"),C.appendChild(t),t.click(),t.remove()})),e}function P(){var e=function(){var e=(0,d.gd)("INPUT");return e.type="file",e.accept="application/json",e.addEventListener("change",(function(n){(0,h.eD)(n,!0).then((e=>{e.index=(0,h.HE)(e),fe(e)})).catch((e=>{(0,w.fZ)(e.message),H("Invalid source")})),e.value=""})),e.style.display="none",e}(),n=(0,d.gd)("A","nx-open-file");n.append((0,d.cy)(f.r5,20)),n.addEventListener("click",(function(){e.click()}));var t=(0,d.gd)("SPAN");return t.append(e,n),t}function J(){ge()!==JSON.stringify(ke().srcData)?b(S,!1):b(S,!0)}function Q(){var e=(0,d.gd)("DIV","nx-edit-nav");y=(0,d.gd)("SPAN","nx-action-feedback"),(S=(0,d.gd)("A","nx-reset")).append((0,d.cy)(f.os,20)),J(),S.addEventListener("click",(function(){S.classList.contains("nx-disabled")||(fe(JSON.parse(ge())),b(S,!0))})),(O=(0,d.gd)("A","nx-save")).append((0,d.cy)(f.Ne,20)),b(O,!0),O.addEventListener("click",(function(){if(!O.classList.contains("nx-disabled")){var e=ke();(0,l.EW)(e.dataUrl,e.srcData),H("saved"),b(O,!0),J()}}));var n,t=(0,d.gd)("DIV");return t.append(S,((n=(0,d.gd)("A","nx-new")).append((0,d.cy)(f.j4,20)),n.addEventListener("click",(function(){fe(u())})),n),P(),O,U()),e.append(y,t),e}function B(e){A("next"===e),R(!1)}function F(){var e;(N=(0,d.gd)("DIV","nx-edit-menu")).append(Q(),(e=(0,d.gd)("DIV","nx-edit-actions nx-history-nav"),(0,d.Q$)(T,B,!0),e.append(T.ctrls.prev.elm,T.ctrls.next.elm),e))}function H(e){var n=(0,v.GY)(e);L&&clearTimeout(L),(0,r.Po)(y,n,25),L=setTimeout((function(){(0,r.Po)(y,"",25)}),1500+20*n.length)}function R(e=!1){b(O,e)}function M(e,n=!1){V&&!n||(A=e,T.count=2,T.position=1,(0,d.eV)(T),R(!1))}function W(e){V=e}var Y,q,_={dataUrl:"nexus-tmp",srcData:null,threadId:"/",threadIndex:-1},G=null,Z=new CustomEvent("editThreadChange"),$=new CustomEvent("IndexChange"),z=null,X=null,K=null,ee={up:f.MK,down:f.jF},ne={};function te(e,n,t=!1){var a=ne[e].idx,d=a+1;t&&(d=a-1),_.srcData.index.splice(d,0,_.srcData.index.splice(a,1)[0]),_.srcData.threads.splice(d,0,_.srcData.threads.splice(a,1)[0]),ne[e].idx=d,ne[n].idx=a}function ae(e,n){0===ne[e].idx?b(n.up,!0):b(n.up,!1),ne[e].idx+1===_.srcData.index.length?b(n.down,!0):b(n.down,!1)}function de(e,n){z.removeChild(e),z.insertBefore(e,n),n.dispatchEvent($),e.dispatchEvent($)}function ie(e,n){var t=(0,d.gd)("DIV","nx-edit-move"),a={up:null,down:null};e.addEventListener("IndexChange",(function(){ae(n,a)})),Object.keys(a).forEach((i=>{a[i]=(0,d.gd)("A","nx-edit-move-"+i),a[i].append((0,d.cy)(ee[i],16)),t.append(a[i]),a[i].addEventListener("click",(function(){!function(e,n,t){var a=function(a){var d,i="up"==n;a||(i=!i),i&&0!==ne[t].idx?(d=e.previousSibling,te(t,d.dataset.ident,!0),de(e,d)):i||ne[t].idx+1===_.srcData.index.length||(d=e.nextSibling,te(t,d.dataset.ident,!1),de(d,e))};M(a),a(!0)}(e,i,n)}))})),ae(n,a),e.append(t)}function re(e,n){var t=(0,d.gd)("FORM","nx-thread-local-form"),a=(0,d.gd)("FIELDSET");a.append(ue(["threads",e,"id"],(function(n){ne[e].id=n.value}))),a.append(ue(["threads",e,"title"],(function(e){var t=n.querySelector(".nx-thread-title");t.textContent!==e.value&&(t.textContent=e.value)}))),a.append(ue(["threads",e,"description"]));var r=(0,d.gd)("FIELDSET");["timestamp","main","aside"].forEach((n=>{r.append(ue(["threads",e,"content",n]))}));var c=(0,d.gd)("FIELDSET"),s=ue(["threads",e,"content","media","type"]);return c.append(ue(["threads",e,"content","media","url"],(function(e,n){if(n){var t=s.querySelector("[data-item="+function(e){for(var n=0;n<i.S3.length;n++)if(e.includes(i.S3[n]))return i.S3[n];var t=e.split(".").pop();for(let[e,n]of Object.entries(k))if(n.includes(t))return e;return"page"}(e.value)+"]");t&&t.click()}}))),c.append(s),c.append(ue(["threads",e,"content","media","caption"])),t.append((0,d.a)("local thread"),a,(0,d.a)("content"),r,(0,d.a)("media",2),c),t}function ce(e,n,t,a){var i=(0,c.O1)(21);ne[t].linked[i]={idx:a};var s,l=(0,d.gd)("DIV","nx-edit-distant-link"),o={linked:null},u=ue(["threads",t,"linked",i],null,o),p=((s=(0,d.gd)("BUTTON","nx-delete-link")).type="button",s.textContent="-",s),h=(0,d.gd)("DIV","nx-distant-link-action");return h.append(p),p.addEventListener("click",(()=>{var a=function(a){var d=ne[t].linked[i].idx,c=ne[t].idx;if(a){(0,r.Vv)(l,200,(function(){l.remove()}));var s=d===_.srcData.threads[c].linked.length-1;if(_.srcData.threads[c].linked.splice(d,1),!s)for(let[e,n]of Object.entries(ne[t].linked))n.idx>d&&(ne[t].linked[e].idx=n.idx-1)}else if(d>_.srcData.threads[c].linked.length-1)_.srcData.threads[c].linked.push(o.linked.value),(0,r.am)(n,l,!1,!0,200);else{_.srcData.threads[c].linked.splice(d,0,o.linked.value);for(let[e,n]of Object.entries(ne[t].linked))n.idx>=d&&e!==i&&(ne[t].linked[e].idx=n.idx+1);var u=n.childNodes[d];n.insertBefore(l,u),(0,r.YQ)(l,200)}D(e,_.srcData.threads[c].linked,"linked")};M(a),a(!0)})),l.append(u,h),l}function se(e){var n=(0,d.gd)("LI");return _.threadId!==ne[e].id&&(n.style.display="none"),n.addEventListener("editThreadChange",(function(){_.threadId===ne[e].id?setTimeout((function(){(0,r.YQ)(n,200)}),200):(0,r.Vv)(n,200)})),n}function le(e){var n={index:{parent:z,child:null,link:null,del:null},local:{parent:X,child:null},distant:{parent:K,child:null}};return n.distant.child=se(e),n.local.child=se(e),n.index.child=(0,d.gd)("LI"),n.index.child.dataset.ident=e,n.index.link=function(e){var n=(0,s.DX)(_,ne[e].id,ne[e].idx),t=(0,d.j1)(n,!1);return _.threadId===ne[e].id&&t.classList.add("nx-on-display"),t.addEventListener("click",(()=>{if(_.threadId!==ne[e].id){_.threadId=ne[e].id,_.threadIndex=ne[e].idx;var n=z.querySelector(".nx-on-display");n&&n.classList.remove("nx-on-display"),t.classList.add("nx-on-display"),X.childNodes.forEach((e=>{e.dispatchEvent(Z)})),K.childNodes.forEach((e=>{e.dispatchEvent(Z)}))}})),t}(e),n.index.child.append(n.index.link),ie(n.index.child,e),n.distant.child.append(function(e){var n=(0,d.gd)("FORM","nx-thread-distant-form"),t=g();if(D(t,_.srcData.threads[ne[e].idx].linked,"linked"),t.addEventListener("click",(()=>{t.disabled||(_.srcData.threads[ne[e].idx].linked.push(""),(0,r.am)(n,ce(t,n,e,_.srcData.threads[ne[e].idx].linked.length-1),!1,!0,200),D(t,_.srcData.threads[ne[e].idx].linked,"linked"))})),Object.prototype.hasOwnProperty.call(_.srcData.threads[ne[e].idx],"linked")){if(_.srcData.threads[ne[e].idx].linked.length){for(var a=[],i=0;i<_.srcData.threads[ne[e].idx].linked.length;i++){var c=ce(t,n,e,i);a.push(c)}n.append(...a)}}else _.srcData.threads[ne[e].idx].linked=[];var s=(0,d.gd)("DIV");return s.append((0,d.a)("linked threads"),n,t),s}(e)),n.local.child.append(re(e,n.index.child)),n.index.del=function(e,n,t,a){var i=(0,d.gd)("BUTTON","nx-delete-thread");return i.type="button",i.textContent="-",i.addEventListener("click",(function(){!function(e,n,t,a){var d=Object.assign({},_.srcData.threads[ne[a].idx]),i=function(i){var c=ne[a].idx,s=_.srcData.index.length;if(i){if(c<s-1)for(let[e,n]of Object.entries(ne))n.idx>c&&(ne[e].idx=n.idx-1);_.srcData.index.splice(c,1),_.srcData.threads.splice(c,1),[n,e,t].forEach((e=>{(0,r.Vv)(e,200,(function(){e.remove()}))})),s>1&&(0===c?t.nextSibling.dispatchEvent($):c===s-1&&t.previousSibling.dispatchEvent($)),_.threadId===ne[a].id?(_.threadId="/",_.threadIndex=-1,n.dispatchEvent(Z),e.dispatchEvent(Z)):_.threadIndex>c&&_.threadIndex--}else{if(_.srcData.index.splice(c,0,d.id),_.srcData.threads.splice(c,0,d),c<=s-1){for(let[e,n]of Object.entries(ne))n.id!==d.id&&n.idx>=c&&(ne[e].idx=n.idx+1);var l=z.childNodes[c];z.insertBefore(t,l),0===c&&l.dispatchEvent($)}else z.append(t),s>1&&t.previousSibling.dispatchEvent($);X.append(e),K.append(n),(0,r.YQ)(t,200),t.firstChild.click()}D(q,_.srcData.index,"threads")};M(i),i(!0)}(e,n,t,a)})),i}(n.local.child,n.distant.child,n.index.child,e),n.index.child.append(n.index.del),n}function oe(e,n){if(null===_.srcData&&(_.srcData={},_.srcData.index=[]),"author"===e[0])return function(e,n){_.srcData.author||(_.srcData.author={}),_.srcData.author[e[1]]=n}(e,n);var t=ne[e[1]].idx;return function(e){_.srcData.threads?void 0===_.srcData.threads[e]&&(_.srcData.threads[e]={}):_.srcData.threads=[]}(t),"id"===e[2]?function(e,n,t){ne[e[1]].id=t,_.srcData.index[n]=t,_.srcData.threads[n].id=t}(e,t,n):["linked","content"].includes(e[2])?"content"===e[2]?function(e,n,t){_.srcData.threads[n].content||(_.srcData.threads[n].content={}),"media"===e[3]?(_.srcData.threads[n].content.media||(_.srcData.threads[n].content.media={}),_.srcData.threads[n].content.media[e[4]]=t):_.srcData.threads[n].content[e[3]]=t}(e,t,n):void function(e,n,t){_.srcData.threads[n].linked?_.srcData.threads[n].linked[ne[e[1]].linked[e[3]].idx]=t:_.srcData.threads[n].linked=[t]}(e,t,n):function(e,n,t){_.srcData.threads[n][e[2]]=t}(e,t,n)}function ue(e,n=null,t=null){var a=function(e){if(_.srcData){if("author"==e[0])return _.srcData[e[0]][e[1]];var n=ne[e[1]].idx;return["linked","content"].includes(e[2])?"content"===e[2]?"media"!==e[3]?_.srcData.threads[n].content[e[3]]:_.srcData.threads[n].content.media[e[4]]:_.srcData.threads[n].linked[ne[e[1]].linked[e[3]].idx]:_.srcData.threads[n][e[2]]}return""}(e),r=e.length-1;"linked"===e[r-1]&&r--;var c=e[r];"threads"===e[--r-1]&&r--;var s,l=e[r];s=["about","description","main","aside","caption"].includes(c)?function(e){var n=(0,d.gd)("TEXTAREA","nx-edit-textarea");return n.textContent=e,n}(a):"timestamp"==c?function(e){var n=(0,d.gd)("INPUT","nx-edit-date");return n.type="datetime-local",n.value=e,n}(a):function(e){var n=(0,d.gd)("INPUT","nx-edit-text");return n.type="text",n.value=e,n}(a),s.classList.add("nx-edit-input");var o=e.join("-");s.id=o,s.name=o,["handle","title","main","id","url","type","timestamp","linked"].includes(c)&&(s.required=!0);var u=c;"linked"===c&&(u="url");var p,h=function(e){var n=(0,d.gd)("LABEL","nx-edit-label");n.for=e;var t=(0,d.gd)("SPAN","nx-edit-title");return t.textContent=(0,v.GY)(e),(0,x.wu)(t,e),n.append(t),n}(u),g=(0,d.gd)("SPAN","nx-edit-indication"),D=((p=(0,d.gd)("SPAN","nx-edit-feedback")).append((0,d.cy)(f.mb)),p);switch(h.append(g,D),c){case"url":case"linked":g.textContent="[http]",s.pattern=i.Ni;break;case"id":g.textContent="[A-Za-z0-9-][3-36]",s.pattern=i.Q1;break;case"type":s.pattern="("+i.WS.join("|")+")";break;case"timestamp":break;default:var k=i.m2[c];g.textContent="["+k[0]+"-"+k[1]+"]",s.setAttribute("maxlength",k[1]),s.setAttribute("minlength",k[0])}t&&(t[c]=s);var m=(0,d.gd)("DIV","nx-edit-input nx-edit-"+l+"-"+c);if(m.append(h),"type"===c){var b=i.WS;m.append((0,d.Sb)(b,s,null,"nx-edit-media-type-select"))}else m.append(s);return function(e,n,t,a){var d=0,i="",r=n.value;n.addEventListener("focus",(function(){r=n.value})),n.addEventListener("change",(function(){(pe(e,n,t,a),d>0)?M((function(d){d?n.value=i:(i=n.value,n.value=r),pe(e,n,t,a)})):d++}))}(e,s,D,n),pe(e,s,D,n),m}function pe(e,n,t,a){var d=n.checkValidity(),i=null;if(d&&e.includes("url")||e.includes("linked"))(d=(0,o.jv)(n.value))&&e.includes("linked")&&(d=E(_.srcData.threads[ne[e[1]].idx].linked,n.value,ne[e[1]].linked[e[3]].idx))&&(i=(0,h.P_)(n.value).then((()=>!0)).catch((()=>!1)));else if(e.includes("id")){var r=I(n.value,ne[e[1]].idx);r!==n.value&&(n.value=r),d=!0}null===i&&(i=Promise.resolve(d)),i.then((d=>{oe(e,n.value),function(e,n){var t=f.mb;n&&(t=f.b8),e.firstChild.src=t}(t,d),"function"==typeof a&&a(n,d)}))}function he(e=!1){["handle","url","about"].forEach((n=>{var t=ue(["author",n]);e?(0,r.am)(Y,t,!1,!0,200):Y.append(t)}))}function ve(e=!1){var n=_.srcData.index;if(n.length){W(!0);for(var t=null,a=0;a<n.length;a++)a===n.length-1&&(t=function(){W(!1)}),xe(a,n[a],t,e)}}function xe(e,n,t,a=!1){var d=(0,c.O1)(21);ne[d]={id:n,idx:e,linked:{}};var i=le(d);for(let[e,d]of Object.entries(i))!a||"index"!==e&&n!==_.threadId?(d.parent.append(d.child),t&&t()):(0,r.am)(d.parent,d.child,!1,!0,200,t)}function fe(e){var n=JSON.stringify(_);null===e&&(e=u());var t=m(e);t.srcData.threads.length&&(t.threadIndex=0,t.threadId=t.srcData.threads[0].id);var a=JSON.stringify(t),d=function(e){if(_.srcData.threads.length){var t=[Y,z,X,K];t.forEach(((d,i)=>{var c=Array.from(d.childNodes),s=i===t.length-1;c.forEach(((t,d)=>{var i=null;s&&d===c.length-1&&(i=function(){var t;t=e?a:n,_=Object.assign({},JSON.parse(t)),he(!0),ve(!0)}),(0,r.Vv)(t,200,(function(){t.remove(),i&&i()}))}))}))}};d(!0),M(d,!0)}function ge(){return G}function De(e,n){C=n;var t,a="nexus-tmp";e=e;(0,j.pm)("new")?(t=u(),e=null):(e.dataUrl&&(a=e.dataUrl),null===(t=(0,l.Ih)(a))&&(t=null!==e.srcData?e.srcData:u(),(0,l.EW)(a,t))),t.index||(t.index=(0,h.HE)(t)),G=null!==e&&null!==e.srcData?JSON.stringify(e.srcData):JSON.stringify(t);var i=t.threads[0].id,s=0;e&&"/"!==e.threadId&&t.index.includes(e.threadId)&&(i=e.threadId,s=t.index.indexOf(e.threadId)),_=m(t,a,i,s),F(),z=(0,d.gd)("UL","nx-edit-index"),X=(0,d.gd)("UL","nx-edit-local"),K=(0,d.gd)("UL","nx-edit-distant"),ve(),Y=(0,d.gd)("FORM","nx-edit-author"),he(),D(q=g(),_.srcData.index,"threads"),q.addEventListener("click",(function(){if(!q.disabled){var e=(0,c.O1)(21),n=(0,c.O1)(10),t=_.srcData.index.length;ne[e]={id:n,idx:t,linked:{}};var a=null;t-1!=-1&&(a=function(){z.childNodes[t-1].dispatchEvent($)}),_.srcData.threads.push(p(n)),_.srcData.index.push(n);var d=le(e);["local","distant"].forEach((e=>{d[e].parent.append(d[e].child)})),(0,r.am)(d.index.parent,d.index.child,!1,!0,200,a),R(!1),D(q,_.srcData.index,"threads")}}))}function ke(){return _}function me(e){De(e.state,e.nxelm);var n=(0,d.gd)("DIV","nx-main-block nx-index");n.append((0,d.rH)("author",[Y],(0,d.a)("author")),(0,d.rH)("threads-list",[z,q],(0,d.a)("threads")));var t=(0,d.gd)("DIV","nx-main-block nx-thread");t.append((0,d.rH)("local",[X],!1),(0,d.rH)("distant",[K],!1));var i=(0,d.IW)((0,d.vi)(),[(0,d._$)([N],[n,t],[],"edit")]),c=(e={editMode:!0,state:Object.assign({},ke())},(0,a.U)(e));c.style.display="none";var l=function(e,n){var t=!1,a=(0,d.gd)("A","nx-edit-switch");return a.append((0,d.cy)(f.xQ,25)),a.addEventListener("click",(function(){(t=!t)?(0,r.U6)(e,(function(){(0,s.f2)(ke(),!0,!0),a.firstChild.src=f.bR,(0,r.Ji)(n)})):(0,r.U6)(n,(function(){a.firstChild.src=f.xQ,(0,r.Ji)(e)}))})),a}(i,c),o=(0,d.gd)("DIV","nx-editor");return o.append(i,c,l),o}}}]);
//# sourceMappingURL=NxIOEdit.js.map